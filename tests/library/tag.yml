- name: tag | create
  doboto_tag:
    token: "{{ lookup('env','DO_API_TOKEN') }}"
    action: create
    name: tag-create
  register: tag_create

- name: tag | create | verify
  assert:
    that:
      - "{{ tag_create.tag.name == 'tag-create' }}"
    msg: "{{ tag_create }}"

- name: tag | info
  doboto_tag:
    action: info
    tag_name: tag-create
  register: tag_info

- name: tag | info | verify
  assert:
    that:
      - "{{ tag_info.tag == tag_create.tag }}"
    msg: "{{ tag_info }}"

- name: tag | list
  doboto_tag:
    action: list
  register: tag_list

- name: tag | list | verify
  assert:
    that:
      - "{{ tag_list|json_query(tag_create_query) == 'tag-create' }}"
    msg: "{{ tag_list }}"
  vars:
    tag_create_query: "tags[?name=='tag-create'].name | [0]"

- name: tag | update
  doboto_tag:
    action: update
    tag_name: tag-create
    name: tag-update

- name: tag | update | reload
  doboto_tag:
    action: info
    tag_name: tag-update
  register: tag_update

- name: tag | update | verify
  assert:
    that:
      - "{{ tag_update.tag.name == 'tag-update' }}"
    msg: "{{ tag_update }}"

- name: tag | attach | create
  doboto_droplet:
    action: create
    name: tag-droplet
    region: nyc3
    size: 1gb
    image: ubuntu-14-04-x64
    wait: true
  register: tag_droplet

- name: tag | attach | droplet
  doboto_tag:
    action: attach
    tag_name: tag-update
    resources:
      -
        resource_id: "{{ tag_droplet.droplet.id }}"
        resource_type: "droplet"

- name: tag | attach | reload
  doboto_droplet:
    action: info
    id: "{{ tag_droplet.droplet.id }}"
  register: droplet_attach

- name: tag | attach | verify
  assert:
    that:
      - "{{ droplet_attach.droplet.tags == ['tag-update'] }}"
    msg: "{{ droplet_attach }}"

- name: tag | detach | droplet
  doboto_tag:
    action: detach
    tag_name: tag-update
    resources:
      -
        resource_id: "{{ tag_droplet.droplet.id }}"
        resource_type: "droplet"

- name: tag | detach | reload
  doboto_droplet:
    action: info
    id: "{{ tag_droplet.droplet.id }}"
  register: droplet_detach

- name: tag | detach | verify
  assert:
    that:
      - "{{ droplet_detach.droplet.tags == [] }}"
    msg: "{{ droplet_detach }}"

- name: tag | destroy
  doboto_tag:
    action: destroy
    tag_name: tag-update
  register: tag_destroy

- name: tag | destroy | verify
  assert:
    that:
      - "{{ tag_destroy.result.status == 204 }}"
    msg: "{{ tag_destroy }}"
